name: Deploy Banner Assets
on:
  push:
    paths:
      - "banner-src/**" # Trigger ONLY when files in this folder change
permissions:
  contents: write # Required to push the new version folder back to the repo
jobs:
  deploy-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Generate Version ID
        id: version
        # Creates a unique version ID based on timestamp (e.g., v1716301234)
        run: echo "id=v$(date +%s)" >> $GITHUB_OUTPUT
      - name: Create New Version Folder
        run: |
          VERSION=${{ steps.version.outputs.id }}
          echo "Deploying version: $VERSION"

          # Create the version directory inside 'banner'
          mkdir -p banner/$VERSION

          # Copy assets from source to the new version folder
          cp -r banner-src/* banner/$VERSION/
      - name: Update version.json
        run: |
          VERSION=${{ steps.version.outputs.id }}

          # Write the new version ID to version.json
          echo "{ \"bannerVersion\": \"$VERSION\" }" > banner/version.json
      - name: Commit and Push
        run: |
          VERSION=${{ steps.version.outputs.id }}

          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          git add banner/
          git commit -m "Deploy banner assets: $VERSION"
          git push

      - name: Purge version.json Cache
        run: |
          # Force jsDelivr to update its cache for the pointer file immediately
          curl -I https://purge.jsdelivr.net/gh/${{ github.repository }}@main/banner/version.json
